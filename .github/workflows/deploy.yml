name: DevSecOps CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/secure-webapp
  AWS_REGION: us-east-1

jobs:
  # Job 1: Code Quality & Security Scanning
  security-scan:
    name: Security & Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          cd app
          pip install -r requirements.txt
          pip install flake8 bandit safety

      - name: Lint with flake8
        run: |
          cd app
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Security scan with Bandit
        run: |
          cd app
          bandit -r . -f json -o bandit-report.json || true
          bandit -r . || true

      - name: Check dependencies for vulnerabilities
        run: |
          cd app
          safety check --json || true

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: app/bandit-report.json

  # Job 2: Build & Scan Docker Image
  build-and-scan:
    name: Build & Scan Docker Image
    runs-on: ubuntu-latest
    needs: security-scan
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          cd app
          docker build -t ${{ env.DOCKER_IMAGE }}:${{ github.sha }} .
          docker tag ${{ env.DOCKER_IMAGE }}:${{ github.sha }} ${{ env.DOCKER_IMAGE }}:latest

      - name: Scan Docker image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.DOCKER_IMAGE }}:${{ github.sha }}
          format: 'table'
          exit-code: '0'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

      - name: Scan Docker image with Trivy (JSON output)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.DOCKER_IMAGE }}:${{ github.sha }}
          format: 'json'
          output: 'trivy-results.json'
          exit-code: '0'

      - name: Upload Trivy scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-results
          path: trivy-results.json

      - name: Log in to Docker Hub
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Push Docker image
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          docker push ${{ env.DOCKER_IMAGE }}:${{ github.sha }}
          docker push ${{ env.DOCKER_IMAGE }}:latest

  # Job 3: Terraform Plan
  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: build-and-scan
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        run: |
          cd terraform
          terraform init

      - name: Terraform Format Check
        run: |
          cd terraform
          terraform fmt -check

      - name: Terraform Validate
        run: |
          cd terraform
          terraform validate

      - name: Terraform Plan
        run: |
          cd terraform
          terraform plan -out=tfplan

      - name: Upload Terraform plan
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: terraform/tfplan

  # Job 4: Deploy to AWS
  deploy:
    name: Deploy to AWS
    runs-on: ubuntu-latest
    needs: build-and-scan
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get EC2 instance IP
        id: get-ip
        run: |
          INSTANCE_IP=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=secure-webapp-server-dev" \
            --query "Reservations[0].Instances[0].PublicIpAddress" \
            --output text)
          echo "instance_ip=$INSTANCE_IP" >> $GITHUB_OUTPUT

      - name: Deploy to EC2
        env:
          PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          INSTANCE_IP: ${{ steps.get-ip.outputs.instance_ip }}
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        run: |
          # Save private key to file
          echo "$PRIVATE_KEY" > private_key.pem
          chmod 600 private_key.pem
          
          # Copy deployment files to EC2
          scp -o StrictHostKeyChecking=no -i private_key.pem \
            docker-compose.prod.yml \
            ec2-user@$INSTANCE_IP:~/
          
          scp -o StrictHostKeyChecking=no -i private_key.pem -r \
            nginx \
            scripts \
            ec2-user@$INSTANCE_IP:~/
          
          # SSH and deploy
          ssh -o StrictHostKeyChecking=no -i private_key.pem ec2-user@$INSTANCE_IP << EOF
            # Create .env file
            cat > .env << 'ENVEOF'
            DOCKERHUB_USERNAME=$DOCKERHUB_USERNAME
            APP_VERSION=${{ github.sha }}
          ENVEOF
            
            # Update docker-compose to use HTTP-only nginx config (no SSL certs yet)
            sed -i 's|./nginx/nginx.conf:/etc/nginx/nginx.conf:ro|./nginx/nginx-http.conf:/etc/nginx/nginx.conf:ro|' docker-compose.prod.yml
            
            # Pull latest images
            docker pull ${{ env.DOCKER_IMAGE }}:latest
            
            # Stop old single container if exists
            docker stop webapp 2>/dev/null || true
            docker rm webapp 2>/dev/null || true
            
            # Deploy with docker-compose
            docker-compose -f docker-compose.prod.yml down || true
            docker-compose -f docker-compose.prod.yml up -d
            
            # Wait for services to start and health checks to pass
            echo "Waiting for containers to become healthy..."
            sleep 20
            
            # Verify deployment
            docker-compose -f docker-compose.prod.yml ps
            
            # Check nginx (port 80) instead of webapp directly
            curl -f http://localhost/health || exit 1
            echo "Health check passed!"
          EOF
          
          # Clean up
          rm -f private_key.pem

      - name: Verify deployment
        run: |
          INSTANCE_IP=${{ steps.get-ip.outputs.instance_ip }}
          echo "Application deployed successfully!"
          echo "URL: http://$INSTANCE_IP"
          curl -f http://$INSTANCE_IP/health

  # Job 5: Post-Deployment Tests
  post-deploy-tests:
    name: Post-Deployment Tests
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get EC2 instance IP
        id: get-ip
        run: |
          INSTANCE_IP=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=secure-webapp-server-dev" \
            --query "Reservations[0].Instances[0].PublicIpAddress" \
            --output text)
          echo "instance_ip=$INSTANCE_IP" >> $GITHUB_OUTPUT

      - name: Health check
        run: |
          INSTANCE_IP=${{ steps.get-ip.outputs.instance_ip }}
          curl -f http://$INSTANCE_IP/health

      - name: Smoke tests
        run: |
          INSTANCE_IP=${{ steps.get-ip.outputs.instance_ip }}
          BASE_URL="http://$INSTANCE_IP"
          
          # Test home endpoint
          curl -f $BASE_URL/
          
          # Test tasks endpoint
          curl -f $BASE_URL/api/tasks
          
          echo "All smoke tests passed!"
